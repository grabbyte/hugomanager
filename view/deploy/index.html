{{ define "deploy/index.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .Title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/deploy/index.css?v=1.0.0" rel="stylesheet">
</head>
<body>
    {{ template "header" . }}

    <!-- 页面标题 -->
    <div class="page-header">
        <div class="container-fluid">
            <h1 class="mb-0" data-i18n="deploy.multi.title">部署管理</h1>
            <p class="mb-0" data-i18n="deploy.multi.subtitle">管理多个部署目标，支持独立配置和部署控制</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- 添加服务器按钮 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 data-i18n="deploy.quick.operations">快速操作</h2>
                    <div>
                        <button class="btn btn-light btn-lg" onclick="showAddServerModal()">
                            <i class="bi bi-plus-circle"></i> <span data-i18n="deploy.server.add">添加服务器</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全局构建和控制区域 -->
        <div class="row mb-4">
            <div class="col-lg-2">
                <h5 class="mb-3" data-i18n="deploy.build.control">构建控制</h5>
                <div class="card action-card">
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <button class="btn btn-success btn-sm w-100" onclick="buildHugo()" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-hammer"></i><br>
                                    <small data-i18n="deploy.build.action">构建</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="cleanAndBuild()" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-arrow-clockwise"></i><br>
                                    <small data-i18n="deploy.clean.action">清理</small>
                                </button>
                            </div>
                        </div>
                        <div class="small text-muted">
                            <div id="buildStatus" class="text-center" data-i18n="deploy.build.waiting">等待构建</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-2">
                <h5 class="mb-3" data-i18n="deploy.preview.service">预览服务</h5>
                <div class="card action-card">
                    <div class="card-body">
                        <div class="mb-2 d-flex align-items-center">
                            <div class="status-icon status-{{ if .Hugo }}{{ .Hugo.Status }}{{ else }}stopped{{ end }}"></div>
                            <small>
                                {{ if and .Hugo (eq .Hugo.Status "running") }}<span data-i18n="serve.status.running">运行中</span>{{ else }}<span data-i18n="serve.status.stopped">已停止</span>{{ end }}
                            </small>
                        </div>
                        {{ if and .Hugo .Hugo.URL }}
                        <div class="mb-2">
                            <a href="{{ .Hugo.URL }}" target="_blank" class="btn btn-sm btn-outline-info w-100">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        {{ end }}
                        <div class="row g-2">
                            {{ if and .Hugo (eq .Hugo.Status "running") }}
                            <div class="col-6">
                                <button class="btn btn-outline-warning btn-sm w-100" onclick="stopHugoServe()" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-stop-fill"></i><br>
                                    <small data-i18n="serve.stop.action">停止</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-info btn-sm w-100" onclick="restartHugoServe()" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-arrow-clockwise"></i><br>
                                    <small data-i18n="serve.restart.action">重启</small>
                                </button>
                            </div>
                            {{ else }}
                            <div class="col-6">
                                <button class="btn btn-outline-success btn-sm w-100" onclick="startHugoServe()" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-play-fill"></i><br>
                                    <small data-i18n="serve.start.action">启动</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary btn-sm w-100" disabled style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-dash-circle"></i><br>
                                    <small data-i18n="serve.not.running">未运行</small>
                                </button>
                            </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-2">
                <h5 class="mb-3" data-i18n="deploy.batch.operations">批量操作</h5>
                <div class="card action-card">
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <button class="btn btn-primary btn-sm w-100" onclick="deployAllServers(false)" disabled id="deployAllBtn" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-upload"></i><br>
                                    <small data-i18n="deploy.full.deploy">全量</small>
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="deployAllServers(true)" disabled id="deployAllIncBtn" style="aspect-ratio: 1; min-height: 45px;">
                                    <i class="bi bi-arrow-up-circle"></i><br>
                                    <small data-i18n="deploy.incremental.deploy">增量</small>
                                </button>
                            </div>
                        </div>
                        <div class="small text-muted text-center">
                            <span data-i18n="deploy.build.required">需先构建</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <h5 class="mb-3" data-i18n="deploy.sync.status">同步状态</h5>
                <div class="card action-card">
                    <div class="card-header bg-{{ if and .Deployment (eq .Deployment.LastSyncStatus "success") }}success{{ else if and .Deployment (eq .Deployment.LastSyncStatus "failed") }}danger{{ else }}secondary{{ end }} text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-cloud-arrow-up"></i> <span data-i18n="deploy.sync.status">同步状态</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="badge bg-{{ if and .Deployment (eq .Deployment.LastSyncStatus "success") }}success{{ else if and .Deployment (eq .Deployment.LastSyncStatus "failed") }}danger{{ else }}secondary{{ end }}">
                                {{ if and .Deployment (eq .Deployment.LastSyncStatus "success") }}<span data-i18n="deploy.sync.success">成功</span>{{ else if and .Deployment (eq .Deployment.LastSyncStatus "failed") }}<span data-i18n="deploy.sync.failed">失败</span>{{ else }}<span data-i18n="deploy.sync.pending">待同步</span>{{ end }}
                            </span>
                        </div>
                        {{ if and .Deployment .Deployment.LastSyncTime }}
                        <div class="small text-muted">
                            <i class="bi bi-clock"></i> {{ .Deployment.LastSyncTime.Format "01-02 15:04" }}
                        </div>
                        {{ end }}
                        {{ if and .Deployment .Deployment.LastSyncMessage }}
                        <div class="small text-muted mt-1" title="{{ .Deployment.LastSyncMessage }}">
                            {{ if gt (len .Deployment.LastSyncMessage) 30 }}
                                {{ .Deployment.LastSyncMessage | printf "%.30s" }}...
                            {{ else }}
                                {{ .Deployment.LastSyncMessage }}
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <h5 class="mb-3" data-i18n="deploy.statistics">统计信息</h5>
                <div class="card action-card">
                    <div class="card-body">
                        {{ if and .Deployment (gt .Deployment.FilesDeployed 0) }}
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 mb-0 text-primary">{{ .Deployment.FilesDeployed }}</div>
                                <small class="text-muted" data-i18n="deploy.files.count">个文件</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 mb-0 text-info">{{ formatBytes .Deployment.BytesTransferred }}</div>
                                <small class="text-muted" data-i18n="deploy.transfer.size">传输量</small>
                            </div>
                        </div>
                        {{ else }}
                        <div class="text-center text-muted">
                            <i class="bi bi-info-circle"></i> <span data-i18n="deploy.no.statistics">暂无统计数据</span>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务器列表表格 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-servers"></i> <span data-i18n="deploy.server.list">服务器列表</span>
                            <span class="badge bg-primary ms-2">{{ len .Servers }}</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover server-table mb-0">
                                <thead>
                                    <tr>
                                        <th data-i18n="deploy.server.name">服务器名称</th>
                                        <th data-i18n="deploy.server.domain">域名</th>
                                        <th data-i18n="deploy.server.host">服务器地址</th>
                                        <th data-i18n="deploy.server.status">状态</th>
                                        <th data-i18n="deploy.server.progress">进度</th>
                                        <th data-i18n="deploy.server.actions">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- DEBUG: 服务器数据调试信息 -->
                                    <!-- 服务器数量: {{ if .Servers }}{{ len .Servers }}{{ else }}nil{{ end }} -->
                                    <!-- 服务器存在: {{ if .Servers }}true{{ else }}false{{ end }} -->
                                    <!-- 条件检查: {{ if and .Servers (gt (len .Servers) 0) }}true{{ else }}false{{ end }} -->
                                    
                                    {{ if gt (len .Servers) 0 }}
                                    {{ range .Servers }}
                                    <tr class="server-row" id="server-row-{{ .ID }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="status-icon status-idle"></div>
                                                <div>
                                                    <strong>{{ .Name }}</strong>
                                                    {{ if not .Enabled }}
                                                    <span class="badge bg-secondary ms-2" data-i18n="deploy.server.disabled">已禁用</span>
                                                    {{ end }}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {{ if .Domain }}
                                            <a href="https://{{ .Domain }}" target="_blank" class="text-decoration-none">
                                                {{ .Domain }} <i class="bi bi-box-arrow-up-right"></i>
                                            </a>
                                            {{ else }}
                                            <span class="text-muted" data-i18n="common.not.set">-</span>
                                            {{ end }}
                                        </td>
                                        <td>
                                            <code>{{ .Host }}:{{ .Port }}</code>
                                        </td>
                                        <td>
                                            <span class="badge status-badge bg-secondary" data-i18n="deploy.status.idle">空闲</span>
                                            <div class="small text-muted mt-1" data-i18n="deploy.waiting.deploy">等待部署</div>
                                        </td>
                                        <td>
                                            <div class="progress-container">
                                                <div class="text-center text-muted">
                                                    <i class="bi bi-dash-circle text-muted fs-4"></i>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="server-actions">
                                                <!-- 配置按钮 -->
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="showConfigModal('{{ .ID }}')" 
                                                        data-i18n-title="deploy.config.server"
                                                        title="配置服务器">
                                                    <i class="bi bi-gear"></i>
                                                </button>
                                                
                                                {{ if .Enabled }}
                                                <!-- 测试连接 -->
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="testConnection('{{ .ID }}')" 
                                                        data-i18n-title="deploy.test.connection"
                                                        title="测试连接">
                                                    <i class="bi bi-wifi"></i>
                                                </button>
                                                
                                                <!-- 上传按钮组 -->
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-success deploy-btn" 
                                                            onclick="deployServer('{{ .ID }}', false)" 
                                                            title="全量上传" disabled>
                                                        <i class="bi bi-upload"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-success deploy-btn" 
                                                            onclick="deployServer('{{ .ID }}', true)" 
                                                            title="增量上传" disabled>
                                                        <i class="bi bi-arrow-up-circle"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- 部署控制按钮组 -->
                                                <div class="btn-group deploy-control-group" role="group" style="display: none;">
                                                    <button type="button" class="btn btn-sm btn-warning pause-btn" 
                                                            onclick="pauseDeployment('{{ .ID }}')" 
                                                            title="暂停上传">
                                                        <i class="bi bi-pause-fill"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-info resume-btn" 
                                                            onclick="resumeDeployment('{{ .ID }}')" 
                                                            title="继续上传" style="display: none;">
                                                        <i class="bi bi-play-fill"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger stop-btn" 
                                                            onclick="stopDeployment('{{ .ID }}')" 
                                                            title="停止上传">
                                                        <i class="bi bi-stop-fill"></i>
                                                    </button>
                                                </div>
                                                {{ end }}
                                                
                                                <!-- 删除按钮 -->
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteServer('{{ .ID }}')" 
                                                        title="删除服务器">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {{ end }}
                                    {{ else }}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="bi bi-server fs-1 mb-3 d-block"></i>
                                            <div data-i18n="deploy.no.servers">暂无服务器配置</div>
                                            <small data-i18n="deploy.no.servers.hint">点击"添加服务器"按钮创建第一个部署目标</small>
                                        </td>
                                    </tr>
                                    {{ end }}
                                </tbody>
                            </table>
                        </div>
                        
                        {{ if not .Servers }}
                        <div class="text-center py-3">
                            <button class="btn btn-primary" onclick="showAddServerModal()">
                                <i class="bi bi-plus-circle"></i> <span data-i18n="deploy.server.add">添加服务器</span>
                            </button>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作日志区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> <span data-i18n="deploy.operation.log">操作日志</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="bi bi-trash"></i> <span data-i18n="deploy.clear.log">清空日志</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="deployLog" class="log-output p-3" style="height: 200px;">
                            <div class="text-muted" data-i18n="deploy.log.ready">准备就绪，等待操作...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务器配置模态框 -->
    <div class="modal fade" id="serverConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="deploy.modal.server.config">服务器配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="serverConfigForm">
                        <input type="hidden" id="serverId" name="server_id">
                        
                        <div class="mb-3">
                            <label for="serverName" class="form-label" data-i18n="deploy.server.name">服务器名称</label>
                            <input type="text" class="form-control" id="serverName" name="name" data-i18n-placeholder="deploy.modal.server.name.placeholder" placeholder="例如：生产服务器" required>
                        </div>

                        <div class="mb-3">
                            <label for="serverDomain" class="form-label" data-i18n="deploy.domain.optional">域名 (可选)</label>
                            <input type="text" class="form-control" id="serverDomain" name="domain" data-i18n-placeholder="deploy.modal.domain.placeholder" placeholder="例如：example.com">
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="serverHost" class="form-label" data-i18n="deploy.server.host">服务器地址</label>
                                    <input type="text" class="form-control" id="serverHost" name="host" data-i18n-placeholder="deploy.host.placeholder" placeholder="例如：192.168.1.100" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="serverPort" class="form-label" data-i18n="common.port">端口</label>
                                    <input type="number" class="form-control" id="serverPort" name="port" value="22" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="serverUsername" class="form-label" data-i18n="deploy.username">用户名</label>
                            <input type="text" class="form-control" id="serverUsername" name="username" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" data-i18n="deploy.auth.method">认证方式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_method" id="authPassword" value="password" checked>
                                <label class="form-check-label" for="authPassword" data-i18n="deploy.auth.password">密码认证</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_method" id="authKey" value="key">
                                <label class="form-check-label" for="authKey" data-i18n="deploy.auth.key">私钥认证</label>
                            </div>
                        </div>

                        <div id="passwordAuth" class="mb-3">
                            <label for="serverPassword" class="form-label" data-i18n="deploy.password">密码</label>
                            <input type="password" class="form-control" id="serverPassword" name="password">
                        </div>

                        <div id="keyAuth" class="mb-3" style="display: none;">
                            <label for="serverKeyPath" class="form-label" data-i18n="deploy.keypath">私钥路径</label>
                            <input type="text" class="form-control" id="serverKeyPath" name="key_path">
                        </div>

                        <div class="mb-3">
                            <label for="serverRemotePath" class="form-label" data-i18n="deploy.remotepath">远程路径</label>
                            <input type="text" class="form-control" id="serverRemotePath" name="remote_path" placeholder="/var/www/html" required>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="serverEnabled" name="enabled" checked>
                                <label class="form-check-label" for="serverEnabled" data-i18n="deploy.modal.enabled">启用此服务器</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('serverConfigForm').dispatchEvent(new Event('submit'))" data-i18n="deploy.modal.save">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="/static/js/i18n.js?v=1.0.0"></script>
    <script src="/static/js/deploy/index.js?v=1.0.0"></script>
    
    {{ template "footer" . }}
</body>
</html>
{{ end }}