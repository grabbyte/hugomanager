{{ define "trash/index.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .Title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .trash-section {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }
        .trash-item {
            transition: background-color 0.2s ease;
            cursor: pointer;
            border-bottom: 1px solid #dee2e6;
        }
        .trash-item:hover {
            background-color: #f8f9fa;
        }
        .trash-item.selected {
            background-color: #e3f2fd;
        }
        .stats-card {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }
    </style>
</head>
<body>
    {{ template "header" . }}

    <!-- 主标题区域 -->
    <div class="trash-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3">回收站</h1>
                    <p class="lead mb-4">管理已删除的文章，可以恢复或永久删除</p>
                    <div class="d-flex gap-3 flex-wrap">
                        <button class="btn btn-light btn-lg" onclick="restoreSelected()">
                            <i class="bi bi-arrow-counterclockwise"></i> 恢复选中
                        </button>
                        <button class="btn btn-outline-light btn-lg" onclick="emptyTrash()">
                            <i class="bi bi-trash3"></i> 清空回收站
                        </button>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card stats-card text-center">
                        <div class="card-body">
                            <h2 class="card-title" id="trashCount">0</h2>
                            <p class="card-text">个文件</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 操作栏 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-trash"></i> 回收站文件
                        </h5>
                        <div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" onclick="selectAll()">
                                    <i class="bi bi-check-all"></i> 全选
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearSelection()">
                                    <i class="bi bi-x"></i> 取消选择
                                </button>
                                <button class="btn btn-outline-success" onclick="restoreSelected()" id="restoreBtn" disabled>
                                    <i class="bi bi-arrow-counterclockwise"></i> 恢复选中
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSelected()" id="deleteBtn" disabled>
                                    <i class="bi bi-trash3"></i> 永久删除
                                </button>
                                <button class="btn btn-outline-info" onclick="refreshTrash()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件列表 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div id="trashList">
                            <!-- 文件列表将通过JavaScript加载 -->
                        </div>
                        
                        <!-- 空状态 -->
                        <div id="emptyState" class="text-center py-5" style="display: none;">
                            <i class="bi bi-trash fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">回收站为空</h5>
                            <p class="text-muted">没有已删除的文件</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 项目信息 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>当前Hugo项目：</strong> {{ .HugoProjectPath }}
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5 py-4 bg-light">
        <div class="container">
            <p class="text-muted mb-0">Hugo Manager © 2025 - 让文件管理更安全</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        let selectedItems = new Set();
        let allTrashItems = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTrashItems();
        });

        // 加载回收站文件列表
        function loadTrashItems() {
            fetch('/api/trash')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('trashList').innerHTML = 
                            '<div class="alert alert-danger m-3">' + data.error + '</div>';
                        return;
                    }
                    
                    allTrashItems = data.items || [];
                    renderTrashItems(allTrashItems);
                    updateTrashCount(allTrashItems.length);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('trashList').innerHTML = 
                        '<div class="alert alert-danger m-3">加载回收站失败</div>';
                });
        }

        // 渲染回收站文件列表
        function renderTrashItems(items) {
            const trashList = document.getElementById('trashList');
            const emptyState = document.getElementById('emptyState');
            
            if (items.length === 0) {
                trashList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            items.forEach(item => {
                const sizeText = formatFileSize(item.size);
                const deleteTime = new Date(item.deleted_time).toLocaleString();
                const icon = item.is_markdown ? 
                    '<i class="bi bi-file-earmark-text text-primary"></i>' : 
                    '<i class="bi bi-file-earmark"></i>';
                
                html += `
                    <div class="trash-item p-3" data-path="${item.trash_path}" onclick="toggleItemSelection('${item.trash_path}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" value="${item.trash_path}" 
                                               onchange="event.stopPropagation(); toggleSelection('${item.trash_path}')">
                                    </div>
                                    ${icon}
                                    <h6 class="mb-0 ms-2">${item.name}</h6>
                                </div>
                                <div class="ms-5">
                                    <small class="text-muted d-block">
                                        <i class="bi bi-folder me-1"></i>
                                        原路径：${item.original_path}
                                    </small>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        删除时间：${deleteTime} • ${sizeText}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-success me-1" 
                                        onclick="event.stopPropagation(); restoreItem('${item.trash_path}')">
                                    <i class="bi bi-arrow-counterclockwise"></i> 恢复
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="event.stopPropagation(); deleteItem('${item.trash_path}')">
                                    <i class="bi bi-trash3"></i> 永久删除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            trashList.innerHTML = html;
        }

        // 更新回收站文件数量显示
        function updateTrashCount(count) {
            document.getElementById('trashCount').textContent = count;
        }

        // 切换单个项目选择
        function toggleItemSelection(trashPath) {
            const checkbox = document.querySelector(`input[value="${trashPath}"]`);
            checkbox.checked = !checkbox.checked;
            toggleSelection(trashPath);
        }

        // 切换选择状态
        function toggleSelection(trashPath) {
            const item = document.querySelector(`[data-path="${trashPath}"]`);
            
            if (selectedItems.has(trashPath)) {
                selectedItems.delete(trashPath);
                item.classList.remove('selected');
            } else {
                selectedItems.add(trashPath);
                item.classList.add('selected');
            }
            
            updateActionButtons();
        }

        // 全选
        function selectAll() {
            const checkboxes = document.querySelectorAll('.trash-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const trashPath = checkbox.value;
                selectedItems.add(trashPath);
                checkbox.checked = true;
                document.querySelector(`[data-path="${trashPath}"]`).classList.add('selected');
            });
            updateActionButtons();
        }

        // 取消选择
        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('.trash-item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('input[type="checkbox"]').checked = false;
            });
            updateActionButtons();
        }

        // 更新操作按钮状态
        function updateActionButtons() {
            const restoreBtn = document.getElementById('restoreBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const count = selectedItems.size;
            
            restoreBtn.disabled = count === 0;
            deleteBtn.disabled = count === 0;
            
            restoreBtn.innerHTML = `<i class="bi bi-arrow-counterclockwise"></i> 恢复选中 (${count})`;
            deleteBtn.innerHTML = `<i class="bi bi-trash3"></i> 永久删除 (${count})`;
        }

        // 恢复单个文件
        function restoreItem(trashPath) {
            if (!confirm('确定要恢复这个文件吗？')) {
                return;
            }
            
            fetch('/api/restore-from-trash', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ trash_path: trashPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('恢复失败: ' + data.error);
                    return;
                }
                
                alert('文件恢复成功\n恢复到: ' + data.restore_path);
                loadTrashItems();
                clearSelection();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('恢复失败: ' + error.message);
            });
        }

        // 恢复选中的文件
        function restoreSelected() {
            if (selectedItems.size === 0) {
                alert('请先选择要恢复的文件');
                return;
            }
            
            if (!confirm(`确定要恢复 ${selectedItems.size} 个文件吗？`)) {
                return;
            }
            
            const paths = Array.from(selectedItems);
            let completed = 0;
            let succeeded = 0;
            
            paths.forEach(trashPath => {
                fetch('/api/restore-from-trash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trash_path: trashPath })
                })
                .then(response => response.json())
                .then(data => {
                    completed++;
                    if (!data.error) {
                        succeeded++;
                    }
                    
                    if (completed === paths.length) {
                        alert(`批量恢复完成\n成功恢复: ${succeeded} 个文件\n失败: ${completed - succeeded} 个文件`);
                        loadTrashItems();
                        clearSelection();
                    }
                })
                .catch(error => {
                    completed++;
                    console.error('Error:', error);
                    
                    if (completed === paths.length) {
                        alert(`批量恢复完成\n成功恢复: ${succeeded} 个文件\n失败: ${completed - succeeded} 个文件`);
                        loadTrashItems();
                        clearSelection();
                    }
                });
            });
        }

        // 永久删除单个文件
        function deleteItem(trashPath) {
            if (!confirm('确定要永久删除这个文件吗？此操作无法撤销！')) {
                return;
            }
            
            fetch('/api/permanent-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ trash_paths: [trashPath] })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('删除失败: ' + data.error);
                    return;
                }
                
                alert(data.message);
                loadTrashItems();
                clearSelection();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败: ' + error.message);
            });
        }

        // 永久删除选中的文件
        function deleteSelected() {
            if (selectedItems.size === 0) {
                alert('请先选择要删除的文件');
                return;
            }
            
            if (!confirm(`确定要永久删除 ${selectedItems.size} 个文件吗？此操作无法撤销！`)) {
                return;
            }
            
            const paths = Array.from(selectedItems);
            
            fetch('/api/permanent-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ trash_paths: paths })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('删除失败: ' + data.error);
                    return;
                }
                
                alert(data.message);
                if (data.failed.length > 0) {
                    console.log('删除失败的文件:', data.failed);
                }
                
                loadTrashItems();
                clearSelection();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败: ' + error.message);
            });
        }

        // 清空回收站
        function emptyTrash() {
            if (!confirm('确定要清空回收站吗？所有文件将被永久删除，此操作无法撤销！')) {
                return;
            }
            
            fetch('/api/empty-trash', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('清空失败: ' + data.error);
                    return;
                }
                
                alert(data.message);
                loadTrashItems();
                clearSelection();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('清空失败: ' + error.message);
            });
        }

        // 刷新回收站
        function refreshTrash() {
            loadTrashItems();
            clearSelection();
        }

        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
    <script src="/static/js/i18n.js"></script>
</body>
</html>
{{ end }}