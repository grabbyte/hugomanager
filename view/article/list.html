{{ define "article/list.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .Title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .article-item {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .article-item:hover {
            background-color: #f8f9fa;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }
        .pagination-info {
            color: #6c757d;
        }
    </style>
</head>
<body>
    {{ template "header" . }}

    <!-- 页面标题 -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3" data-i18n="articles.title">文章列表</h1>
                    <p class="lead mb-0" data-i18n="articles.subtitle">浏览所有博客文章，支持分页和时间筛选</p>
                </div>
                <div class="col-lg-4">
                    <div class="text-end">
                        <div class="card bg-white text-dark">
                            <div class="card-body text-center">
                                <h3 class="card-title">{{ .TotalArticles }}</h3>
                                <p class="card-text" data-i18n="articles.total.count">篇文章</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tab导航 -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="articleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ if ne .SelectedStatus "draft" }}active{{ end }}" 
                                id="published-tab" data-bs-toggle="tab" data-bs-target="#published" 
                                type="button" role="tab" onclick="switchTab('published')">
                            <i class="bi bi-file-earmark-check me-2"></i>
                            <span data-i18n="articles.tab.published">已发布</span>
                            <span class="badge bg-primary ms-1">{{ .PublishedCount }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ if eq .SelectedStatus "draft" }}active{{ end }}" 
                                id="draft-tab" data-bs-toggle="tab" data-bs-target="#draft" 
                                type="button" role="tab" onclick="switchTab('draft')">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <span data-i18n="articles.tab.drafts">草稿箱</span>
                            <span class="badge bg-warning ms-1">{{ .DraftCount }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {{ if eq .SelectedStatus "issues" }}active{{ end }}" 
                                id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" 
                                type="button" role="tab" onclick="switchTab('issues')">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span data-i18n="articles.tab.issues">问题检测</span>
                            <span class="badge bg-danger ms-1">{{ .IssuesCount }}</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 搜索和筛选区域 -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="bi bi-search"></i> <span data-i18n="articles.search.filter">搜索和筛选</span>
            </h5>
            
            <!-- 搜索栏 -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label" data-i18n="articles.search">搜索文章</label>
                    <input type="text" class="form-control" id="searchInput" value="{{ .SearchKeyword }}" 
                           data-i18n-placeholder="articles.search.placeholder" 
                           placeholder="输入关键词搜索标题或内容..." onkeyup="handleSearchKeyPress(event)">
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.search.actions">搜索操作</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <i class="bi bi-search"></i> <span data-i18n="articles.search.button">搜索</span>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSearch()">
                            <i class="bi bi-x-circle"></i> <span data-i18n="articles.search.clear">清除</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 筛选栏 -->
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.year">按年份筛选</label>
                    <select class="form-select" id="yearFilter" onchange="applyFilter()">
                        <option value="" data-i18n="articles.filter.all.years">所有年份</option>
                        {{ range .AvailableYears }}
                        <option value="{{ . }}" {{ if eq . $.SelectedYear }}selected{{ end }}>{{ . }}年</option>
                        {{ end }}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.month">按月份筛选</label>
                    <select class="form-select" id="monthFilter" onchange="applyFilter()">
                        <option value="" data-i18n="articles.filter.all.months">所有月份</option>
                        <option value="1" {{ if eq 1 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.1">1月</option>
                        <option value="2" {{ if eq 2 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.2">2月</option>
                        <option value="3" {{ if eq 3 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.3">3月</option>
                        <option value="4" {{ if eq 4 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.4">4月</option>
                        <option value="5" {{ if eq 5 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.5">5月</option>
                        <option value="6" {{ if eq 6 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.6">6月</option>
                        <option value="7" {{ if eq 7 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.7">7月</option>
                        <option value="8" {{ if eq 8 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.8">8月</option>
                        <option value="9" {{ if eq 9 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.9">9月</option>
                        <option value="10" {{ if eq 10 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.10">10月</option>
                        <option value="11" {{ if eq 11 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.11">11月</option>
                        <option value="12" {{ if eq 12 .SelectedMonth }}selected{{ end }} data-i18n="articles.month.12">12月</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.actions">筛选操作</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-info" onclick="applyFilter()">
                            <i class="bi bi-funnel"></i> <span data-i18n="articles.filter.apply">应用筛选</span>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearAllFilters()">
                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="articles.filter.clear.all">清除全部</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 搜索结果提示 -->
            {{ if .SearchKeyword }}
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-search me-2"></i>
                        <strong data-i18n="articles.search.results">搜索结果：</strong>
                        "{{ .SearchKeyword }}" - 
                        <span data-i18n="articles.search.found">找到</span> {{ .TotalArticles }} 
                        <span data-i18n="articles.search.articles">篇文章</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="clearSearch()">
                            <i class="bi bi-x"></i> <span data-i18n="articles.search.clear">清除搜索</span>
                        </button>
                    </div>
                </div>
            </div>
            {{ end }}
        </div>

        <!-- 文章列表 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> <span data-i18n="articles.list">文章列表</span>
                </h5>
                <div class="pagination-info">
                    <span data-i18n="articles.showing">显示</span>
                    {{ $start := add (mul (sub .CurrentPage 1) .PageSize) 1 }}
                    {{ $end := .PageSize }}
                    {{ if gt (mul .CurrentPage .PageSize) .TotalArticles }}
                        {{ $end = sub .TotalArticles (mul (sub .CurrentPage 1) .PageSize) }}
                    {{ end }}
                    {{ $start }} - {{ add (sub $start 1) $end }} / {{ .TotalArticles }}
                    <span data-i18n="articles.items">项</span>
                </div>
            </div>
            <div class="card-body p-0">
                {{ if .Articles }}
                    {{ range $index, $article := .Articles }}
                    <div class="article-item p-3 border-bottom{{ if $article.IsDraft }} bg-light{{ end }}" data-article="{{ $article.Path }}" onclick="editArticle('{{ $article.Path }}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">
                                    {{ if $article.IsDraft }}
                                    <i class="bi bi-file-earmark-text text-warning me-2"></i>
                                    <span class="badge bg-warning text-dark me-2" data-i18n="articles.draft.badge">草稿</span>
                                    {{ else }}
                                    <i class="bi bi-file-earmark-check text-success me-2"></i>
                                    {{ end }}
                                    <span class="article-title">
                                        {{ if $article.Title }}{{ $article.Title }}{{ else }}{{ $article.Path }}{{ end }}
                                    </span>
                                </h6>
                                <div class="small text-muted mb-1">
                                    <i class="bi bi-calendar me-1"></i>
                                    <span>{{ $article.FormattedTime }}</span>
                                    <i class="bi bi-file-earmark ms-3 me-1"></i>
                                    <span>{{ formatFileSize $article.Size }}</span>
                                </div>
                                
                                <!-- 问题显示 -->
                                {{ if $article.HasIssues }}
                                <div class="small text-danger mt-2">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <strong data-i18n="articles.issues.detected">发现问题：</strong>
                                    <div class="ms-3 mt-1">
                                        {{ range $article.Issues }}
                                        <span class="badge bg-danger me-1 mb-1">{{ . }}</span>
                                        {{ end }}
                                    </div>
                                </div>
                                {{ end }}
                                
                                <!-- 摘要显示 -->
                                {{ if and $article.Summary (ne $.SelectedStatus "issues") }}
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-file-text me-1"></i>
                                    <span>{{ $article.Summary }}</span>
                                </div>
                                {{ end }}
                                <small class="text-muted">
                                    <i class="bi bi-folder me-1"></i>
                                    {{ if contains $article.Path "/" }}
                                        {{ index (split $article.Path "/") 0 }}
                                    {{ else }}
                                        <span data-i18n="articles.root.directory">根目录</span>
                                    {{ end }}
                                </small>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); editArticle('{{ $article.Path }}')">
                                    <i class="bi bi-pencil"></i> <span data-i18n="articles.edit">编辑</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteArticle('{{ $article.Path }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {{ end }}
                {{ else }}
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted" data-i18n="articles.no.articles">暂无文章</h5>
                        <p class="text-muted" data-i18n="articles.no.articles.hint">当前筛选条件下没有找到文章</p>
                        <button class="btn btn-primary" onclick="location.href='/'">
                            <i class="bi bi-house"></i> <span data-i18n="articles.back.home">返回首页</span>
                        </button>
                    </div>
                {{ end }}
            </div>
        </div>

        <!-- 分页 -->
        {{ if gt .TotalPages 1 }}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <!-- 首页 -->
                        {{ if gt .CurrentPage 1 }}
                        <li class="page-item">
                            <a class="page-link" href="{{ buildPageURL 1 .SelectedYear .SelectedMonth }}">
                                <i class="bi bi-chevron-double-left"></i> <span data-i18n="articles.pagination.first">首页</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{{ buildPageURL (sub .CurrentPage 1) .SelectedYear .SelectedMonth }}">
                                <i class="bi bi-chevron-left"></i> <span data-i18n="articles.pagination.prev">上一页</span>
                            </a>
                        </li>
                        {{ end }}

                        <!-- 页码 -->
                        {{ $current := .CurrentPage }}
                        {{ $total := .TotalPages }}
                        {{ $start := sub $current 2 }}
                        {{ if lt $start 1 }}{{ $start = 1 }}{{ end }}
                        {{ $end := add $current 2 }}
                        {{ if gt $end $total }}{{ $end = $total }}{{ end }}

                        {{ range seq $start $end }}
                        {{ if eq . $current }}
                        <li class="page-item active">
                            <span class="page-link">{{ . }}</span>
                        </li>
                        {{ else }}
                        <li class="page-item">
                            <a class="page-link" href="{{ buildPageURL . $.SelectedYear $.SelectedMonth }}">{{ . }}</a>
                        </li>
                        {{ end }}
                        {{ end }}

                        <!-- 下一页 -->
                        {{ if lt .CurrentPage .TotalPages }}
                        <li class="page-item">
                            <a class="page-link" href="{{ buildPageURL (add .CurrentPage 1) .SelectedYear .SelectedMonth }}">
                                <span data-i18n="articles.pagination.next">下一页</span> <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{{ buildPageURL .TotalPages .SelectedYear .SelectedMonth }}">
                                <span data-i18n="articles.pagination.last">末页</span> <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                        {{ end }}
                    </ul>
                </nav>
            </div>
        </div>
        {{ end }}

        <!-- 项目信息 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong data-i18n="articles.current.project">当前Hugo项目：</strong> {{ .HugoProjectPath }}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        // 切换Tab
        function switchTab(status) {
            let url = '/articles?page=1';
            if (status && status !== 'published') {
                url += '&status=' + status;
            }
            location.href = url;
        }

        // 应用筛选
        function applyFilter() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const search = document.getElementById('searchInput').value;
            
            let url = '/articles?page=1';
            {{ if .SelectedStatus }}
            url += '&status={{ .SelectedStatus }}';
            {{ end }}
            if (year) url += '&year=' + year;
            if (month) url += '&month=' + month;
            if (search) url += '&search=' + encodeURIComponent(search);
            
            location.href = url;
        }

        // 执行搜索
        function performSearch() {
            const search = document.getElementById('searchInput').value.trim();
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            let url = '/articles?page=1';
            {{ if .SelectedStatus }}
            url += '&status={{ .SelectedStatus }}';
            {{ end }}
            if (search) url += '&search=' + encodeURIComponent(search);
            if (year) url += '&year=' + year;
            if (month) url += '&month=' + month;
            
            location.href = url;
        }

        // 清除搜索
        function clearSearch() {
            let url = '/articles?page=1';
            {{ if .SelectedStatus }}
            url += '&status={{ .SelectedStatus }}';
            {{ end }}
            location.href = url;
        }

        // 处理搜索框回车键
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        // 清除所有筛选
        function clearAllFilters() {
            let url = '/articles?page=1';
            {{ if .SelectedStatus }}
            url += '&status={{ .SelectedStatus }}';
            {{ end }}
            location.href = url;
        }

        // 编辑文章
        function editArticle(articlePath) {
            const editorUrl = '/files/edit?file=' + encodeURIComponent(articlePath);
            window.open(editorUrl, '_blank');
        }

        // 删除文章
        function deleteArticle(articlePath) {
            if (confirm(getTranslation('articles.delete.confirm', '确定要删除这篇文章吗？文章将移至回收站。') + '\n\n' + articlePath)) {
                fetch('/api/delete-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: articlePath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(getTranslation('articles.delete.failed', '删除失败') + ': ' + data.error);
                        return;
                    }
                    
                    alert(getTranslation('articles.delete.success', '文章已移至回收站'));
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(getTranslation('articles.delete.error', '删除失败') + ': ' + error.message);
                });
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 构建分页URL
        function buildPageURL(page, year, month) {
            let url = '/articles?page=' + page;
            if (year) url += '&year=' + year;
            if (month) url += '&month=' + month;
            return url;
        }
    </script>
    <script src="/static/js/i18n.js"></script>
</body>
</html>
{{ end }}