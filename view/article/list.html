{{ define "article/list.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .Title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .article-item {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .article-item:hover {
            background-color: #f8f9fa;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }
        .pagination-info {
            color: #6c757d;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .preview-header {
            border-left: 4px solid #007bff;
        }
        .markdown-content {
            line-height: 1.6;
            font-size: 16px;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }
        .markdown-content code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }
        .markdown-content blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin-left: 0;
            color: #6c757d;
        }
    </style>
</head>
<body>
    {{ template "header" . }}

    <!-- 页面标题 -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h1 class="display-5 fw-bold mb-3" data-i18n="articles.title">文章列表</h1>
                            <p class="lead mb-0" data-i18n="articles.subtitle">浏览所有博客文章，支持分页和时间筛选</p>
                        </div>
                        <div>
                            <button type="button" class="btn btn-light btn-lg me-2" onclick="showNewArticleModal()">
                                <i class="bi bi-plus-circle me-2"></i>
                                <span data-i18n="articles.new.article">新建文章</span>
                            </button>
                            <div class="btn-group">
                                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-clock-history me-1"></i><span data-i18n="datetime.repair.title">时间修复</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="checkDateFormats()">
                                        <i class="bi bi-search me-2"></i><span data-i18n="datetime.repair.check">检查时间格式</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="repairAllDates()">
                                        <i class="bi bi-tools me-2"></i><span data-i18n="datetime.repair.batch">批量修复时间</span>
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="text-end">
                        <div class="card bg-white text-dark">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="totalArticlesCount">0</h3>
                                <p class="card-text" data-i18n="articles.total.count">篇文章</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tab导航 -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="articleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" 
                                id="published-tab" data-bs-toggle="tab" data-bs-target="#published" 
                                type="button" role="tab" onclick="switchTab('published')">
                            <i class="bi bi-file-earmark-check me-2"></i>
                            <span data-i18n="articles.tab.published">已发布</span>
                            <span class="badge bg-primary ms-1" id="publishedCountBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" 
                                id="draft-tab" data-bs-toggle="tab" data-bs-target="#draft" 
                                type="button" role="tab" onclick="switchTab('draft')">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <span data-i18n="articles.tab.drafts">草稿箱</span>
                            <span class="badge bg-warning ms-1" id="draftCountBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" 
                                id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" 
                                type="button" role="tab" onclick="switchTab('issues')">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span data-i18n="articles.tab.issues">问题检测</span>
                            <span class="badge bg-danger ms-1" id="issuesCountBadge">0</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 搜索和筛选区域 -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="bi bi-search"></i> <span data-i18n="articles.search.filter">搜索和筛选</span>
            </h5>
            
            <!-- 搜索栏 -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label" data-i18n="articles.search">搜索文章</label>
                    <input type="text" class="form-control" id="searchInput"
                           data-i18n-placeholder="articles.search.placeholder" 
                           placeholder="输入关键词搜索标题或内容...">
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.search.actions">搜索操作</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <i class="bi bi-search"></i> <span data-i18n="articles.search.button">搜索</span>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSearch()">
                            <i class="bi bi-x-circle"></i> <span data-i18n="articles.search.clear">清除</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 筛选栏 -->
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.year">按年份筛选</label>
                    <select class="form-select" id="yearFilter" onchange="applyFilter()">
                        <option value="" data-i18n="articles.filter.all.years">所有年份</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.month">按月份筛选</label>
                    <select class="form-select" id="monthFilter" onchange="applyFilter()">
                        <option value="" data-i18n="articles.filter.all.months">所有月份</option>
                        <option value="1" data-i18n="articles.month.1">1月</option>
                        <option value="2" data-i18n="articles.month.2">2月</option>
                        <option value="3" data-i18n="articles.month.3">3月</option>
                        <option value="4" data-i18n="articles.month.4">4月</option>
                        <option value="5" data-i18n="articles.month.5">5月</option>
                        <option value="6" data-i18n="articles.month.6">6月</option>
                        <option value="7" data-i18n="articles.month.7">7月</option>
                        <option value="8" data-i18n="articles.month.8">8月</option>
                        <option value="9" data-i18n="articles.month.9">9月</option>
                        <option value="10" data-i18n="articles.month.10">10月</option>
                        <option value="11" data-i18n="articles.month.11">11月</option>
                        <option value="12" data-i18n="articles.month.12">12月</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-i18n="articles.filter.actions">筛选操作</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-info" onclick="applyFilter()">
                            <i class="bi bi-funnel"></i> <span data-i18n="articles.filter.apply">应用筛选</span>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearAllFilters()">
                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="articles.filter.clear.all">清除全部</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 搜索结果提示 -->
            <div class="row mt-3" id="searchResultAlert" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-search me-2"></i>
                        <strong data-i18n="articles.search.results">搜索结果：</strong>
                        <span id="searchResultText"></span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="clearSearch()">
                            <i class="bi bi-x"></i> <span data-i18n="articles.search.clear">清除搜索</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加载指示器 -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">正在加载文章...</p>
        </div>

        <!-- 文章列表 -->
        <div class="card" id="articleListCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> <span data-i18n="articles.list">文章列表</span>
                </h5>
                <div class="pagination-info" id="paginationInfo">
                </div>
            </div>
            <div class="card-body p-0" id="articleListContainer">
                <!-- 文章列表将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 分页 -->
        <div class="row mt-4" id="paginationContainer">
            <!-- 分页将通过JavaScript动态生成 -->
        </div>

        <!-- 项目信息 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong data-i18n="articles.current.project">当前Hugo项目：</strong> <span id="hugoProjectPath"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建文章模态框 -->
    <div class="modal fade" id="newArticleModal" tabindex="-1" aria-labelledby="newArticleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newArticleModalLabel">
                        <i class="bi bi-plus-circle me-2"></i><span data-i18n="articles.new.article">新建文章</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newArticleForm">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="newArticleTitle" class="form-label">
                                    <i class="bi bi-type me-1"></i>文章标题 *
                                </label>
                                <input type="text" class="form-control" id="newArticleTitle" required 
                                       placeholder="请输入文章标题...">
                                <div class="form-text">标题将用于生成文件名和URL</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newArticleAuthor" class="form-label">
                                    <i class="bi bi-person me-1"></i>作者
                                </label>
                                <input type="text" class="form-control" id="newArticleAuthor" 
                                       value="软件开发大郭" placeholder="请输入作者姓名...">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newArticleType" class="form-label">
                                    <i class="bi bi-bookmark me-1"></i>文章类型
                                </label>
                                <select class="form-select" id="newArticleType">
                                    <option value="post" selected>post (博客文章)</option>
                                    <option value="page">page (静态页面)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="newArticleCategories" class="form-label">
                                    <i class="bi bi-folder me-1"></i>分类
                                </label>
                                <input type="text" class="form-control" id="newArticleCategories" 
                                       placeholder="输入分类，用逗号分隔...">
                                <div class="form-text">例如：技术, 编程, Web开发</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="newArticleTags" class="form-label">
                                    <i class="bi bi-tags me-1"></i>标签
                                </label>
                                <input type="text" class="form-control" id="newArticleTags" 
                                       placeholder="输入标签，用逗号分隔...">
                                <div class="form-text">例如：Hugo, Go, 博客, 教程</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="newArticleDirectory" class="form-label">
                                    <i class="bi bi-folder2 me-1"></i>目录
                                </label>
                                <select class="form-select" id="newArticleDirectory">
                                    <option value="posts" selected>posts (默认文章目录)</option>
                                </select>
                                <div class="form-text">选择文章保存的目录，支持子目录选择</div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>自动生成规则：</strong>
                            <ul class="mb-0 mt-2">
                                <li>文件名格式：日期-清理后的标题.md</li>
                                <li>URL将根据文件路径自动生成</li>
                                <li>创建后可以进一步编辑文章内容和元数据</li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createNewArticle()">
                        <i class="bi bi-plus-circle me-1"></i>创建文章
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文章预览模态框 -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">
                        <i class="bi bi-eye me-2"></i><span data-i18n="articles.preview.title">文章预览</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="previewContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2" data-i18n="articles.preview.loading">正在加载文章内容...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">关闭</button>
                    <button type="button" class="btn btn-primary" id="editFromPreviewBtn" onclick="editCurrentArticle()">
                        <i class="bi bi-pencil me-1"></i><span data-i18n="articles.edit">编辑</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 时间格式检查结果模态框 -->
    <div class="modal fade" id="dateFormatCheckModal" tabindex="-1" aria-labelledby="dateFormatCheckModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dateFormatCheckModalLabel">
                        <i class="bi bi-clock-history me-2"></i><span data-i18n="datetime.repair.check">检查时间格式</span>结果
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dateCheckResults">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">正在检查时间格式...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">关闭</button>
                    <button type="button" class="btn btn-warning" id="bulkRepairBtn" onclick="repairAllDates()" style="display:none;">
                        <i class="bi bi-tools me-1"></i><span data-i18n="datetime.repair.batch">批量修复所有问题</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="/static/js/i18n.js"></script>
    
    <script>
        // 全局变量
        let currentPage = 1;
        let currentStatus = 'published';
        let currentSearch = '';
        let currentYear = '';
        let currentMonth = '';
        let statsData = {};
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL参数获取初始状态
            const urlParams = new URLSearchParams(window.location.search);
            currentPage = parseInt(urlParams.get('page')) || 1;
            currentStatus = urlParams.get('status') || 'published';
            currentSearch = urlParams.get('search') || '';
            currentYear = urlParams.get('year') || '';
            currentMonth = urlParams.get('month') || '';
            
            // 设置表单初始值
            document.getElementById('searchInput').value = currentSearch;
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            
            // 设置活动tab
            setActiveTab(currentStatus);
            
            // 加载统计数据和文章列表
            loadArticleStats();
            loadArticles();
            
            // 绑定搜索框回车事件
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });
        
        // 加载文章统计数据
        async function loadArticleStats() {
            try {
                const response = await fetch('/api/articles/stats');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Failed to load article stats:', data.error);
                    return;
                }
                
                statsData = data;
                
                // 更新统计数字
                document.getElementById('totalArticlesCount').textContent = data.total_articles;
                document.getElementById('publishedCountBadge').textContent = data.published_count;
                document.getElementById('draftCountBadge').textContent = data.draft_count;
                document.getElementById('issuesCountBadge').textContent = data.issues_count;
                document.getElementById('hugoProjectPath').textContent = data.hugo_project_path;
                
                // 更新年份选项（如果有年份统计数据，使用统计数据；否则使用原有数据）
                const yearSelect = document.getElementById('yearFilter');
                yearSelect.innerHTML = '<option value="" data-i18n="articles.filter.all.years">所有年份</option>';
                
                if (data.year_stats && data.year_stats.length > 0) {
                    // 使用新的年份统计数据（包含博客数量）
                    data.year_stats.forEach(yearStat => {
                        const option = document.createElement('option');
                        option.value = yearStat.year;
                        option.textContent = `${yearStat.year}年 (${yearStat.count}篇)`;
                        if (yearStat.year.toString() === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    });
                } else {
                    // 使用原有年份数据（向后兼容）
                    data.available_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year + '年';
                        if (year.toString() === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    });
                }
                
                // 更新月份选项（添加博客数量显示）
                if (data.month_stats && data.month_stats.length > 0) {
                    const monthSelect = document.getElementById('monthFilter');
                    const monthNames = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    
                    // 创建月份统计映射
                    const monthCountMap = {};
                    data.month_stats.forEach(monthStat => {
                        monthCountMap[monthStat.month] = monthStat.count;
                    });
                    
                    // 更新月份选项的文本，添加博客数量
                    for (let i = 1; i <= 12; i++) {
                        const option = monthSelect.querySelector(`option[value="${i}"]`);
                        if (option && monthCountMap[i]) {
                            option.textContent = `${monthNames[i]} (${monthCountMap[i]}篇)`;
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error loading article stats:', error);
            }
        }
        
        // 加载文章列表
        async function loadArticles() {
            showLoading();
            
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    status: currentStatus,
                    page_size: 20
                });
                
                if (currentSearch) params.append('search', currentSearch);
                if (currentYear) params.append('year', currentYear);
                if (currentMonth) params.append('month', currentMonth);
                
                const response = await fetch(`/api/articles?${params}`);
                const data = await response.json();
                
                if (data.error) {
                    showError('加载文章失败: ' + data.error);
                    return;
                }
                
                renderArticles(data.articles);
                renderPagination(data);
                updatePaginationInfo(data);
                updateSearchResultAlert();
                
            } catch (error) {
                console.error('Error loading articles:', error);
                showError('网络错误: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 渲染文章列表
        function renderArticles(articles) {
            const container = document.getElementById('articleListContainer');
            
            if (!articles || articles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted" data-i18n="articles.no.articles">暂无文章</h5>
                        <p class="text-muted" data-i18n="articles.no.articles.hint">当前筛选条件下没有找到文章</p>
                        <button class="btn btn-primary" onclick="location.href='/'">
                            <i class="bi bi-house"></i> <span data-i18n="articles.back.home">返回首页</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            articles.forEach(article => {
                const directory = article.Path.includes('/') ? article.Path.split('/')[0] : '根目录';
                const isDraft = article.IsDraft;
                const draftBadge = isDraft ? '<span class="badge bg-warning text-dark me-2" data-i18n="articles.draft.badge">草稿</span>' : '';
                const draftClass = isDraft ? ' bg-light' : '';
                
                html += `
                    <div class="article-item p-3 border-bottom${draftClass}" data-article="${article.Path}" onclick="handleEditArticle(this)">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">
                                    ${isDraft ? 
                                        '<i class="bi bi-file-earmark-text text-warning me-2"></i>' : 
                                        '<i class="bi bi-file-earmark-check text-success me-2"></i>'
                                    }
                                    ${draftBadge}
                                    <span class="article-title">${article.Title || article.Path}</span>
                                </h6>
                                <div class="small text-muted mb-1">
                                    <i class="bi bi-calendar me-1"></i>
                                    <span>${article.FormattedTime}</span>
                                    <i class="bi bi-file-earmark ms-3 me-1"></i>
                                    <span>${formatFileSize(article.Size)}</span>
                                </div>
                `;
                
                // 显示问题
                if (article.HasIssues && article.Issues) {
                    html += `
                        <div class="small text-danger mt-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong data-i18n="articles.issues.detected">发现问题：</strong>
                            <div class="ms-3 mt-1">
                    `;
                    article.Issues.forEach(issue => {
                        html += `<span class="badge bg-danger me-1 mb-1">${issue}</span>`;
                    });
                    html += `</div></div>`;
                }
                
                // 显示摘要
                if (article.Summary && currentStatus !== 'issues') {
                    html += `
                        <div class="small text-muted mt-2">
                            <i class="bi bi-file-text me-1"></i>
                            <span>${article.Summary}</span>
                        </div>
                    `;
                }
                
                html += `
                                <small class="text-muted">
                                    <i class="bi bi-folder me-1"></i>
                                    ${directory}
                                </small>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-info me-1" data-article="${article.Path}" onclick="event.stopPropagation(); handlePreviewArticle(this)">
                                    <i class="bi bi-eye"></i> <span data-i18n="articles.preview">预览</span>
                                </button>
                                <button class="btn btn-sm btn-outline-primary me-1" data-article="${article.Path}" onclick="event.stopPropagation(); handleEditArticle(this)">
                                    <i class="bi bi-pencil"></i> <span data-i18n="articles.edit">编辑</span>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-article="${article.Path}" onclick="event.stopPropagation(); handleDeleteArticle(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 渲染分页
        function renderPagination(data) {
            const container = document.getElementById('paginationContainer');
            
            if (data.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `
                <div class="col-12">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
            `;
            
            // 首页和上一页
            if (data.has_prev) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(1)">
                            <i class="bi bi-chevron-double-left"></i> <span data-i18n="articles.pagination.first">首页</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(${data.current_page - 1})">
                            <i class="bi bi-chevron-left"></i> <span data-i18n="articles.pagination.prev">上一页</span>
                        </a>
                    </li>
                `;
            }
            
            // 页码
            const start = Math.max(1, data.current_page - 2);
            const end = Math.min(data.total_pages, data.current_page + 2);
            
            for (let i = start; i <= end; i++) {
                if (i === data.current_page) {
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
                }
            }
            
            // 下一页和末页
            if (data.has_next) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(${data.current_page + 1})">
                            <span data-i18n="articles.pagination.next">下一页</span> <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(${data.total_pages})">
                            <span data-i18n="articles.pagination.last">末页</span> <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                `;
            }
            
            html += `
                    </ul>
                </nav>
            </div>
            `;
            
            container.innerHTML = html;
        }
        
        // 更新分页信息
        function updatePaginationInfo(data) {
            const info = document.getElementById('paginationInfo');
            const start = (data.current_page - 1) * data.page_size + 1;
            const end = Math.min(data.current_page * data.page_size, data.total_articles);
            
            info.textContent = `显示 ${start} - ${end} / ${data.total_articles} 项`;
        }
        
        // 更新搜索结果提示
        function updateSearchResultAlert() {
            const alert = document.getElementById('searchResultAlert');
            const text = document.getElementById('searchResultText');
            
            if (currentSearch) {
                text.textContent = `"${currentSearch}"`;
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        
        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('articleListCard').style.display = 'none';
        }
        
        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('articleListCard').style.display = 'block';
        }
        
        // 显示错误
        function showError(message) {
            const container = document.getElementById('articleListContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle fs-1 text-danger mb-3"></i>
                    <h5 class="text-danger">加载失败</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary" onclick="loadArticles()">
                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                    </button>
                </div>
            `;
        }
        
        // 设置活动tab
        function setActiveTab(status) {
            // 移除所有active类
            document.querySelectorAll('#articleTabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 设置对应tab为active
            let activeTab = 'published-tab';
            if (status === 'draft') activeTab = 'draft-tab';
            else if (status === 'issues') activeTab = 'issues-tab';
            
            document.getElementById(activeTab).classList.add('active');
        }
        
        // 切换Tab
        function switchTab(status) {
            if (currentStatus === status) return;
            
            currentStatus = status;
            currentPage = 1;
            setActiveTab(status);
            updateURL();
            loadArticles();
        }
        
        // 跳转到指定页面
        function goToPage(page) {
            if (page === currentPage) return;
            
            currentPage = page;
            updateURL();
            loadArticles();
        }
        
        // 执行搜索
        function performSearch() {
            const searchValue = document.getElementById('searchInput').value.trim();
            const yearValue = document.getElementById('yearFilter').value;
            const monthValue = document.getElementById('monthFilter').value;
            
            currentSearch = searchValue;
            currentYear = yearValue;
            currentMonth = monthValue;
            currentPage = 1;
            
            updateURL();
            loadArticles();
        }
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            
            updateURL();
            loadArticles();
        }
        
        // 应用筛选
        function applyFilter() {
            performSearch();
        }
        
        // 清除所有筛选
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            
            currentSearch = '';
            currentYear = '';
            currentMonth = '';
            currentPage = 1;
            
            updateURL();
            loadArticles();
        }
        
        // 更新URL
        function updateURL() {
            const params = new URLSearchParams();
            params.set('page', currentPage);
            
            if (currentStatus && currentStatus !== 'published') {
                params.set('status', currentStatus);
            }
            if (currentSearch) params.set('search', currentSearch);
            if (currentYear) params.set('year', currentYear);
            if (currentMonth) params.set('month', currentMonth);
            
            const newURL = '/articles?' + params.toString();
            window.history.replaceState({}, '', newURL);
        }
        
        // 处理预览文章按钮点击
        function handlePreviewArticle(elem) {
            const path = elem.getAttribute('data-article');
            previewArticle(path);
        }

        // 处理编辑文章按钮点击
        function handleEditArticle(elem) {
            const path = elem.getAttribute('data-article');
            editArticle(path);
        }

        // 处理删除文章按钮点击
        function handleDeleteArticle(elem) {
            const path = elem.getAttribute('data-article');
            deleteArticle(path);
        }
        
        // 预览文章
        let currentPreviewPath = '';
        
        async function previewArticle(articlePath) {
            currentPreviewPath = articlePath;
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            
            // 重置预览内容
            const loadingText = window.getTranslation ? 
                window.getTranslation('articles.preview.loading', '正在加载文章内容...') : 
                '正在加载文章内容...';
            document.getElementById('previewContent').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">${loadingText}</p>
                </div>
            `;
            
            modal.show();
            
            try {
                const response = await fetch('/api/article/preview?path=' + encodeURIComponent(articlePath));
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('previewContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            加载失败: ${data.error}
                        </div>
                    `;
                    return;
                }
                
                renderPreviewContent(data);
                
            } catch (error) {
                console.error('Error loading article preview:', error);
                document.getElementById('previewContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // 渲染预览内容
        function renderPreviewContent(data) {
            const content = document.getElementById('previewContent');
            
            let html = `
                <div class="preview-header mb-4 p-3 bg-light rounded">
                    <h2 class="mb-3">${data.title || '无标题'}</h2>
                    <div class="row text-muted small">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <i class="bi bi-person me-1"></i>
                                <strong>作者:</strong> ${data.metadata.author || '未知'}
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-calendar me-1"></i>
                                <strong>发布时间:</strong> ${data.metadata.date || '未设置'}
                            </div>
                        </div>
                        <div class="col-md-6">
                            ${data.metadata.categories ? `
                                <div class="mb-2">
                                    <i class="bi bi-folder me-1"></i>
                                    <strong>分类:</strong> ${data.metadata.categories.join(', ')}
                                </div>
                            ` : ''}
                            ${data.metadata.tags ? `
                                <div class="mb-2">
                                    <i class="bi bi-tags me-1"></i>
                                    <strong>标签:</strong> ${data.metadata.tags.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${data.metadata.draft ? '<span class="badge bg-warning">草稿</span>' : '<span class="badge bg-success">已发布</span>'}
                </div>
                
                <div class="preview-content">
                    <div class="markdown-content">${data.content}</div>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // 从预览页面编辑文章
        function editCurrentArticle() {
            if (currentPreviewPath) {
                editArticle(currentPreviewPath);
            }
        }

        // 编辑文章
        function editArticle(articlePath) {
            const editorUrl = '/article/edit?path=' + encodeURIComponent(articlePath);
            window.open(editorUrl, '_blank');
        }
        
        // 删除文章
        function deleteArticle(articlePath) {
            const confirmMsg = window.getTranslation ? 
                window.getTranslation('articles.delete.confirm', '确定要删除这篇文章吗？文章将移至回收站。') : 
                '确定要删除这篇文章吗？文章将移至回收站。';
                
            if (confirm(confirmMsg + '\n\n' + articlePath)) {
                fetch('/api/delete-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: articlePath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const failedMsg = window.getTranslation ? 
                            window.getTranslation('articles.delete.failed', '删除失败') : 
                            '删除失败';
                        alert(failedMsg + ': ' + data.error);
                        return;
                    }
                    
                    const successMsg = window.getTranslation ? 
                        window.getTranslation('articles.delete.success', '文章已移至回收站') : 
                        '文章已移至回收站';
                    alert(successMsg);
                    
                    // 重新加载统计数据和文章列表
                    loadArticleStats();
                    loadArticles();
                })
                .catch(error => {
                    console.error('Error:', error);
                    const errorMsg = window.getTranslation ? 
                        window.getTranslation('articles.delete.error', '删除失败') : 
                        '删除失败';
                    alert(errorMsg + ': ' + error.message);
                });
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // 显示新建文章模态框
        function showNewArticleModal() {
            // 更新目录选择列表
            updateDirectoryOptions();
            
            const modal = new bootstrap.Modal(document.getElementById('newArticleModal'));
            
            // 重置表单
            document.getElementById('newArticleForm').reset();
            document.getElementById('newArticleAuthor').value = '软件开发大郭';
            document.getElementById('newArticleType').value = 'post';
            document.getElementById('newArticleDirectory').value = 'posts';
            
            modal.show();
        }

        // 更新目录选项
        function updateDirectoryOptions() {
            const select = document.getElementById('newArticleDirectory');
            
            // 从目录树中获取所有目录
            fetch('/api/directory-tree')
                .then(response => response.json())
                .then(data => {
                    if (data.error) return;
                    
                    // 清空现有选项，保留默认选项
                    select.innerHTML = '<option value="posts" selected>posts (默认文章目录)</option>';
                    
                    // 递归添加目录选项
                    addDirectoryOptions(select, data, '');
                })
                .catch(error => {
                    console.error('Error loading directory options:', error);
                });
        }

        // 递归添加目录选项
        function addDirectoryOptions(select, node, parentPath) {
            if (node.children) {
                for (const child of node.children) {
                    const childPath = parentPath ? `${parentPath}/${child.name}` : child.name;
                    
                    // 添加选项（排除已有的posts选项）
                    if (childPath !== 'posts') {
                        const option = document.createElement('option');
                        option.value = childPath;
                        option.textContent = childPath;
                        select.appendChild(option);
                    }
                    
                    // 递归处理子目录
                    if (child.children && child.children.length > 0) {
                        addDirectoryOptions(select, child, childPath);
                    }
                }
            }
        }
        
        // 创建新文章
        async function createNewArticle() {
            const title = document.getElementById('newArticleTitle').value.trim();
            const author = document.getElementById('newArticleAuthor').value.trim();
            const type = document.getElementById('newArticleType').value;
            const categories = document.getElementById('newArticleCategories').value.trim();
            const tags = document.getElementById('newArticleTags').value.trim();
            const directory = document.getElementById('newArticleDirectory').value;
            
            // 验证必填字段
            if (!title) {
                alert('请输入文章标题');
                document.getElementById('newArticleTitle').focus();
                return;
            }
            
            // 处理分类和标签
            const categoriesArray = categories ? categories.split(',').map(c => c.trim()).filter(c => c) : [];
            const tagsArray = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];
            
            // 禁用创建按钮，显示加载状态
            const createBtn = event.target;
            const originalText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>创建中...';
            
            try {
                const response = await fetch('/api/create-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        author: author || '软件开发大郭',
                        type: type,
                        categories: categoriesArray,
                        tags: tagsArray,
                        directory: directory
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('创建失败: ' + data.error);
                    return;
                }
                
                // 成功创建
                alert('文章创建成功！');
                
                // 隐藏模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('newArticleModal'));
                modal.hide();
                
                // 刷新文章列表
                loadArticleStats();
                loadArticles();
                
                // 询问是否立即编辑
                if (confirm('是否立即编辑新创建的文章？')) {
                    const editorUrl = '/article/edit?path=' + encodeURIComponent(data.path);
                    window.open(editorUrl, '_blank');
                }
                
            } catch (error) {
                console.error('Error creating article:', error);
                alert('创建失败: ' + error.message);
            } finally {
                // 恢复按钮状态
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            }
        }
        
        // Claude Prompt: 时间格式检查功能
        // 检查所有文章的时间格式
        async function checkDateFormats() {
            const modal = new bootstrap.Modal(document.getElementById('dateFormatCheckModal'));
            
            // 重置模态框内容
            const checkingText = window.getTranslation ? window.getTranslation('datetime.repair.checking', '正在检查时间格式...') : '正在检查时间格式...';
            document.getElementById('dateCheckResults').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">${checkingText}</p>
                </div>
            `;
            document.getElementById('bulkRepairBtn').style.display = 'none';
            
            modal.show();
            
            try {
                const response = await fetch('/api/check-date-formats');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('dateCheckResults').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            检查失败: ${data.error}
                        </div>
                    `;
                    return;
                }
                
                renderDateCheckResults(data);
                
                // 如果有问题文件，显示批量修复按钮
                if (data.invalid_count > 0) {
                    document.getElementById('bulkRepairBtn').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking date formats:', error);
                document.getElementById('dateCheckResults').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // 渲染时间检查结果
        function renderDateCheckResults(data) {
            const totalFilesText = window.getTranslation ? window.getTranslation('datetime.repair.total.files', '总文件数') : '总文件数';
            const validCountText = window.getTranslation ? window.getTranslation('datetime.repair.valid.count', '格式正确') : '格式正确';
            const invalidCountText = window.getTranslation ? window.getTranslation('datetime.repair.invalid.count', '需要修复') : '需要修复';
            const successRateText = window.getTranslation ? window.getTranslation('datetime.repair.success.rate', '正确率') : '正确率';
            
            let html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="card-title text-primary">${data.total_files}</h3>
                                <p class="card-text">${totalFilesText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="card-title text-success">${data.valid_count}</h3>
                                <p class="card-text">${validCountText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="card-title text-danger">${data.invalid_count}</h3>
                                <p class="card-text">${invalidCountText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="card-title text-warning">${Math.round(data.valid_count / data.total_files * 100)}%</h3>
                                <p class="card-text">${successRateText}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.invalid_count > 0) {
                const invalidFilesText = window.getTranslation ? window.getTranslation('datetime.repair.invalid.files', '需要修复的文件') : '需要修复的文件';
                const problemTypeText = window.getTranslation ? window.getTranslation('datetime.repair.problem.type', '问题类型') : '问题类型';
                const currentFormatText = window.getTranslation ? window.getTranslation('datetime.repair.current.format', '当前格式') : '当前格式';
                const suggestedFormatText = window.getTranslation ? window.getTranslation('datetime.repair.suggested.format', '建议格式') : '建议格式';
                const actionText = window.getTranslation ? window.getTranslation('datetime.repair.action', '操作') : '操作';
                
                html += `
                    <h6 class="mt-4 mb-3">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        ${invalidFilesText} (${data.invalid_count} 个)
                    </h6>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>文件</th>
                                    <th>${problemTypeText}</th>
                                    <th>${currentFormatText}</th>
                                    <th>${suggestedFormatText}</th>
                                    <th>${actionText}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                const missingDateText = window.getTranslation ? window.getTranslation('datetime.repair.missing.date', '缺少日期') : '缺少日期';
                const invalidFormatText = window.getTranslation ? window.getTranslation('datetime.repair.invalid.format', '格式错误') : '格式错误';
                const readErrorText = window.getTranslation ? window.getTranslation('datetime.repair.read.error', '读取失败') : '读取失败';
                const cannotFixText = window.getTranslation ? window.getTranslation('datetime.repair.cannot.fix', '无法修复') : '无法修复';
                const singleFixText = window.getTranslation ? window.getTranslation('datetime.repair.single.fix', '修复') : '修复';
                
                data.invalid_files.forEach(file => {
                    const statusClass = file.status === 'missing_date' ? 'table-warning' : 
                                       file.status === 'invalid_format' ? 'table-danger' : 'table-secondary';
                    const statusText = file.status === 'missing_date' ? missingDateText :
                                      file.status === 'invalid_format' ? invalidFormatText : readErrorText;
                    
                    html += `
                        <tr class="${statusClass}">
                            <td><code>${file.file}</code></td>
                            <td><span class="badge bg-danger">${statusText}</span></td>
                            <td><code>${file.current || '无'}</code></td>
                            <td><code>${file.suggested || '无法生成'}</code></td>
                            <td>
                                ${file.status === 'invalid_format' ? 
                                    `<button class="btn btn-sm btn-warning" onclick="repairSingleDate('${file.file}')">
                                        <i class="bi bi-tools"></i> ${singleFixText}
                                    </button>` : 
                                    `<span class="text-muted">${cannotFixText}</span>`
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                const allSuccessText = window.getTranslation ? window.getTranslation('datetime.repair.all.success', '太棒了！') : '太棒了！';
                const allValidText = window.getTranslation ? window.getTranslation('datetime.repair.all.valid', '所有文章的时间格式都符合Hugo要求') : '所有文章的时间格式都符合Hugo要求';
                
                html += `
                    <div class="alert alert-success text-center">
                        <i class="bi bi-check-circle fs-1 text-success mb-3"></i>
                        <h5>${allSuccessText}</h5>
                        <p class="mb-0">${allValidText}</p>
                    </div>
                `;
            }
            
            document.getElementById('dateCheckResults').innerHTML = html;
        }
        
        // 批量修复所有时间格式问题
        async function repairAllDates() {
            const confirmText = window.getTranslation ? window.getTranslation('datetime.repair.confirm', '确定要批量修复所有博客的时间格式吗？\\n这将修改文件内容，建议先备份。') : '确定要批量修复所有博客的时间格式吗？\n这将修改文件内容，建议先备份。';
            if (!confirm(confirmText)) {
                return;
            }
            
            const originalBtn = event?.target || document.getElementById('bulkRepairBtn');
            const originalText = originalBtn.innerHTML;
            originalBtn.disabled = true;
            const repairingText = window.getTranslation ? window.getTranslation('datetime.repair.repairing', '修复中...') : '修复中...';
            originalBtn.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>${repairingText}`;
            
            try {
                const response = await fetch('/api/repair-all-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('批量修复失败: ' + data.error);
                    return;
                }
                
                // 显示修复结果
                const completedText = window.getTranslation ? window.getTranslation('datetime.repair.completed', '批量修复完成！') : '批量修复完成！';
                const totalFilesLabel = window.getTranslation ? window.getTranslation('datetime.repair.total.files', '总文件数') : '总文件数';
                const repairedLabel = '修复成功'; // 可以添加到翻译文件
                const failedLabel = '修复失败';   // 可以添加到翻译文件
                
                let message = `${completedText}\n\n`;
                message += `${totalFilesLabel}: ${data.total_files}\n`;
                message += `${repairedLabel}: ${data.repaired_count}\n`;
                message += `${failedLabel}: ${data.failed_count}\n`;
                
                if (data.failed_count > 0) {
                    message += '\n失败文件:\n';
                    data.failed_files.forEach(failed => {
                        message += `- ${failed.file}: ${failed.error}\n`;
                    });
                }
                
                alert(message);
                
                // 隐藏模态框并刷新列表
                const modal = bootstrap.Modal.getInstance(document.getElementById('dateFormatCheckModal'));
                modal.hide();
                
                // 重新检查格式状态
                setTimeout(() => {
                    loadArticleStats();
                    loadArticles();
                }, 1000);
                
            } catch (error) {
                console.error('Error repairing all dates:', error);
                alert('批量修复失败: ' + error.message);
            } finally {
                originalBtn.disabled = false;
                originalBtn.innerHTML = originalText;
            }
        }
        
        // 修复单个文件的时间格式
        async function repairSingleDate(filePath) {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            try {
                const response = await fetch('/api/repair-single-date', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: filePath
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('修复失败: ' + data.error);
                    return;
                }
                
                const successText = window.getTranslation ? window.getTranslation('datetime.repair.success.single', '修复成功！') : '修复成功！';
                alert(successText);
                
                // 重新检查格式
                checkDateFormats();
                
            } catch (error) {
                console.error('Error repairing single date:', error);
                alert('修复失败: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
{{ end }}