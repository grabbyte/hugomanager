
{{ define "home/index.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ .Title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
            margin-bottom: 30px;
        }
        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .search-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .article-item {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .article-item:hover {
            background-color: #f8f9fa;
        }
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
    </style>
</head>
<body>
    {{ template "header" . }}

    <!-- 主标题区域 -->
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3" data-i18n="home.title">Hugo 博客管理器</h1>
                    <p class="lead mb-4" data-i18n="home.subtitle">简单、高效的Hugo静态博客管理工具</p>
                    <div class="d-flex gap-3 flex-wrap">
                        <button class="btn btn-light btn-lg" onclick="createNewArticle()">
                            <i class="bi bi-plus-circle"></i> <span data-i18n="home.new.article">新建文章</span>
                        </button>
                        <button class="btn btn-outline-light btn-lg" onclick="location.href='/files'">
                            <i class="bi bi-folder-open"></i> <span data-i18n="home.manage.files">管理文件</span>
                        </button>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card stats-card text-center">
                        <div class="card-body">
                            <h2 class="card-title" id="articleCount">{{ len .Articles }}</h2>
                            <p class="card-text" data-i18n="home.articles.count">篇文章</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 搜索区域 -->
        <div class="search-section">
            <h5 class="mb-3">
                <i class="bi bi-search"></i> <span data-i18n="home.search.articles">搜索文章</span>
            </h5>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="searchInput" data-i18n-placeholder="home.search.placeholder" placeholder="输入关键词搜索文章标题、内容..." onkeyup="performSearch()">
                </div>
                <div class="col-md-4 mt-2 mt-md-0">
                    <button class="btn btn-primary w-100" onclick="performSearch()">
                        <i class="bi bi-search"></i> <span data-i18n="home.search.button">搜索</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 功能卡片区域 -->
        <div class="row mb-5">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="createNewArticle()">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-file-earmark-plus fs-1 text-primary mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.new.blog">新建博客</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.new.blog.desc">快速创建新的博客文章</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="location.href='/files'">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-folder2-open fs-1 text-info mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.file.management">文件管理</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.file.management.desc">浏览和编辑所有文件</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="location.href='/images'">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-folder2-open fs-1 text-success mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.static.files">静态文件</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.static.files.desc">管理Hugo项目的静态文件资源</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="location.href='/deploy'">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-cloud-upload fs-1 text-danger mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.deploy">部署管理</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.deploy.desc">构建和部署到服务器</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="location.href='/trash'">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-trash fs-1 text-warning mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.trash">回收站</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.trash.desc">查看已删除的文章</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                <div class="card feature-card h-100 text-center" onclick="location.href='/settings'">
                    <div class="card-body d-flex flex-column">
                        <i class="bi bi-gear fs-1 text-secondary mb-3"></i>
                        <h5 class="card-title" data-i18n="home.card.settings">系统设置</h5>
                        <p class="card-text flex-grow-1" data-i18n="home.card.settings.desc">配置系统参数</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近文章列表 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> <span data-i18n="home.recent.articles">最近文章</span>
                        </h5>
                        <div>
                            <span class="text-muted" id="searchResultInfo"></span>
                            {{ if gt .TotalArticles 20 }}
                            <a href="/articles" class="btn btn-sm btn-outline-info ms-2">
                                <i class="bi bi-list-ul"></i> <span data-i18n="home.view.all.articles">查看全部文章</span>
                            </a>
                            {{ end }}
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshArticles()">
                                <i class="bi bi-arrow-clockwise"></i> <span data-i18n="home.refresh">刷新</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="articlesList">
                            {{ if .Articles }}
                                {{ range $index, $article := .Articles }}
                                <div class="article-item p-3 border-bottom" data-article="{{ $article }}" onclick="handleEditArticle(this)">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <i class="bi bi-file-earmark-text text-primary me-2"></i>
                                                <span class="article-title">{{ $article }}</span>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="bi bi-folder me-1"></i>
                                                <span data-i18n="home.root.directory">根目录</span>
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <button class="btn btn-sm btn-outline-primary me-1" data-article="{{ $article }}" onclick="event.stopPropagation(); handleEditArticle(this)">
                                                <i class="bi bi-pencil"></i> <span data-i18n="home.edit">编辑</span>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" data-article="{{ $article }}" onclick="event.stopPropagation(); handleDeleteArticle(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {{ end }}
                            {{ else }}
                                <div class="text-center py-5">
                                    <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                                    <h5 class="text-muted" data-i18n="home.no.articles">暂无文章</h5>
                                    <p class="text-muted" data-i18n="home.no.articles.hint">点击上方"新建文章"按钮开始创作吧！</p>
                                    <button class="btn btn-primary" onclick="createNewArticle()">
                                        <i class="bi bi-plus-circle"></i> <span data-i18n="home.create.now">立即创建</span>
                                    </button>
                                </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 项目信息 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong data-i18n="home.current.hugo.project">当前Hugo项目：</strong> {{ .HugoProjectPath }}
                </div>
            </div>
        </div>
    </div>

    <!-- 新建文章模态框 -->
    <div class="modal fade" id="newArticleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-plus"></i> <span data-i18n="home.modal.new.article">新建文章</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quickNewArticleForm">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="home.modal.article.title">文章标题 *</label>
                            <input type="text" class="form-control" id="quickTitle" required data-i18n-placeholder="home.modal.title.placeholder" placeholder="例如：我的第一篇博客">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="home.modal.save.directory">保存目录</label>
                            <select class="form-select" id="quickDirectory">
                                <option value="posts" data-i18n="home.modal.posts.default">posts (默认)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="home.modal.article.type">文章类型</label>
                            <select class="form-select" id="quickType">
                                <option value="post" data-i18n="home.modal.blog.article">博客文章</option>
                                <option value="page" data-i18n="home.modal.static.page">静态页面</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="home.modal.cancel">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createQuickArticle()">
                        <i class="bi bi-plus-circle"></i> <span data-i18n="home.modal.create.and.edit">创建并编辑</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5 py-4 bg-light">
        <div class="container">
            <p class="text-muted mb-0" data-i18n="home.footer.copyright">Hugo Manager © 2025 - 让博客写作更简单</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        let allArticles = [
            {{ range $index, $article := .Articles }}
                {{ if $index }},{{ end }}"{{ $article }}"
            {{ end }}
        ];
        let currentSearchResults = allArticles;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateSearchInfo();
        });

        // 执行搜索
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                currentSearchResults = allArticles;
            } else {
                currentSearchResults = allArticles.filter(article => 
                    article.toLowerCase().includes(searchTerm)
                );
            }
            
            displaySearchResults();
            updateSearchInfo();
        }

        // 显示搜索结果
        function displaySearchResults() {
            const articlesList = document.getElementById('articlesList');
            
            if (currentSearchResults.length === 0) {
                articlesList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-search fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">${getTranslation('home.search.no.results', '未找到匹配的文章')}</h5>
                        <p class="text-muted">${getTranslation('home.search.try.different', '尝试使用不同的关键词进行搜索')}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            currentSearchResults.forEach(article => {
                const directory = article.includes('/') ? article.split('/')[0] : getTranslation('home.root.directory', '根目录');
                html += `
                    <div class="article-item p-3 border-bottom" data-article="${article}" onclick="handleEditArticle(this)">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="bi bi-file-earmark-text text-primary me-2"></i>
                                    <span class="article-title">${article}</span>
                                </h6>
                                <small class="text-muted">
                                    <i class="bi bi-folder me-1"></i>
                                    ${directory}
                                </small>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" data-article="${article}" onclick="handleEditArticle(this)">
                                    <i class="bi bi-pencil"></i> ${getTranslation('home.edit', '编辑')}
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-article="${article}" onclick="event.stopPropagation(); handleDeleteArticle(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            articlesList.innerHTML = html;
        }

        // 更新搜索信息显示
        function updateSearchInfo() {
            const info = document.getElementById('searchResultInfo');
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (searchTerm === '') {
                info.textContent = getTranslation('home.articles.total', `共 ${allArticles.length} 篇文章`).replace('{count}', allArticles.length);
            } else {
                info.textContent = getTranslation('home.search.found', `找到 ${currentSearchResults.length} 篇相关文章`).replace('{count}', currentSearchResults.length);
            }
        }
        function handleEditArticle(elem) {
            const path = elem.getAttribute('data-article');
            editArticle(path);
        }

        function handleDeleteArticle(elem) {
            const path = elem.getAttribute('data-article');
            deleteArticle(path);
        }
        // 编辑文章
        function editArticle(articlePath) {
            const editorUrl = '/files/edit?file=' + encodeURIComponent(articlePath);
            window.open(editorUrl, '_blank');
        }

        // 删除文章
        function deleteArticle(articlePath) {
            if (confirm(getTranslation('home.delete.confirm', '确定要删除这篇文章吗？文章将移至回收站。') + '\n\n' + articlePath)) {
                fetch('/api/delete-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        path: articlePath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(getTranslation('home.delete.failed', '删除失败') + ': ' + data.error);
                        return;
                    }
                    
                    alert(getTranslation('home.delete.success', '文章已移至回收站'));
                    refreshArticles();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(getTranslation('home.delete.error', '删除失败') + ': ' + error.message);
                });
            }
        }

        // 创建新文章
        function createNewArticle() {
            // 更新目录选择
            updateDirectoryOptions('quickDirectory');
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('newArticleModal'));
            modal.show();
        }

        // 创建快速文章
        function createQuickArticle() {
            const title = document.getElementById('quickTitle').value.trim();
            const directory = document.getElementById('quickDirectory').value;
            const type = document.getElementById('quickType').value;

            if (!title) {
                alert(getTranslation('home.modal.title.required', '请输入文章标题'));
                return;
            }

            const requestData = {
                title: title,
                directory: directory,
                type: type,
                author: '',
                categories: [],
                tags: []
            };

            fetch('/api/create-article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(getTranslation('home.modal.create.failed', '创建失败') + ': ' + data.error);
                    return;
                }

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('newArticleModal'));
                modal.hide();
                
                // 清空表单
                document.getElementById('quickNewArticleForm').reset();
                
                // 刷新文章列表
                refreshArticles();
                
                // 打开编辑页面
                setTimeout(() => {
                    editArticle(data.path);
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(getTranslation('home.modal.create.error', '创建失败'));
            });
        }

        // 更新目录选项
        function updateDirectoryOptions(selectId) {
            const select = document.getElementById(selectId);
            
            // 从目录树获取所有目录
            fetch('/api/directory-tree')
                .then(response => response.json())
                .then(data => {
                    if (data.error) return;
                    
                    // 清空现有选项
                    select.innerHTML = `<option value="posts">${getTranslation('home.modal.posts.default', 'posts (默认)')}</option>`;
                    
                    // 递归添加目录选项
                    addDirectoryOptions(select, data, '');
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 递归添加目录选项
        function addDirectoryOptions(select, node, parentPath) {
            if (node.children) {
                for (const child of node.children) {
                    const childPath = parentPath ? `${parentPath}/${child.name}` : child.name;
                    
                    // 添加选项
                    if (childPath !== 'posts') {  // posts已经是默认选项
                        const option = document.createElement('option');
                        option.value = childPath;
                        option.textContent = childPath;
                        select.appendChild(option);
                    }
                    
                    // 递归处理子目录
                    if (child.children && child.children.length > 0) {
                        addDirectoryOptions(select, child, childPath);
                    }
                }
            }
        }

        // 刷新文章列表
        function refreshArticles() {
            location.reload();
        }

        // 支持回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
    <script src="/static/js/i18n.js"></script>
</body>
</html>
{{ end }}
